# ğŸ¯ Guide Complet : CrÃ©er un ModÃ¨le Tesseract PersonnalisÃ© pour Votre Application

Ce guide vous permettra de crÃ©er un modÃ¨le `.traineddata` spÃ©cialisÃ© dans la reconnaissance de l'Ã©criture manuscrite pour amÃ©liorer drastiquement la prÃ©cision de votre systÃ¨me de correction automatique.

---

## ğŸ“‹ SOMMAIRE

1. [PrÃ©paration de l'environnement](#phase-1-prÃ©paration-de-lenvironnement)
2. [CrÃ©ation de la base de donnÃ©es d'entraÃ®nement](#phase-2-crÃ©ation-de-la-base-dentraÃ®nement)
3. [Lancement du fine-tuning](#phase-3-lancement-du-fine-tuning)
4. [IntÃ©gration dans votre application](#phase-4-intÃ©gration-dans-lapplication)
5. [Optimisations avancÃ©es](#phase-5-optimisations-avancÃ©es)
6. [DÃ©pannage](#dÃ©pannage)

---

## ğŸ”§ PHASE 1 : PRÃ‰PARATION DE L'ENVIRONNEMENT

**â±ï¸ Temps estimÃ© : 1-2 heures**

### âœ… Ã‰tape 1.1 : Installer les dÃ©pendances systÃ¨me

#### ğŸªŸ Sur Windows (RecommandÃ© : WSL)

```powershell
# Dans PowerShell en tant qu'administrateur
wsl --install

# RedÃ©marrer l'ordinateur, puis ouvrir WSL Ubuntu et taper :
sudo apt-get update
sudo apt-get install -y tesseract-ocr automake autoconf libtool pkg-config \
  libpng-dev libjpeg-dev libtiff-dev zlib1g-dev git make bc
```

#### ğŸ Sur Mac

```bash
brew install tesseract automake autoconf libtool pkg-config libpng jpeg libtiff bc
```

#### ğŸ§ Sur Linux (Debian/Ubuntu)

```bash
sudo apt-get update
sudo apt-get install -y tesseract-ocr automake autoconf libtool pkg-config \
  libpng-dev libjpeg-dev libtiff-dev zlib1g-dev git make bc
```

**âœ”ï¸ VÃ©rification :**
```bash
tesseract --version
# RÃ©sultat attendu : tesseract 4.x.x ou 5.x.x
```

---

### âœ… Ã‰tape 1.2 : Cloner le dÃ©pÃ´t `tesstrain`

```bash
# Naviguer vers votre dossier de travail
cd ~/Documents

# Cloner le dÃ©pÃ´t officiel
git clone https://github.com/tesseract-ocr/tesstrain.git

# Entrer dans le dossier
cd tesstrain
```

**âœ”ï¸ VÃ©rification :**
```bash
ls -la
# Vous devriez voir : data/, Makefile, requirements.txt, etc.
```

---

### âœ… Ã‰tape 1.3 : Installer les dÃ©pendances Python

```bash
# CrÃ©er un environnement virtuel (recommandÃ©)
python3 -m venv venv

# Activer l'environnement
source venv/bin/activate  # Sur Windows WSL/Linux
# venv\Scripts\activate   # Sur Windows CMD

# Installer les dÃ©pendances
pip install --upgrade pip
pip install -r requirements.txt
```

**âœ”ï¸ VÃ©rification :**
```bash
pip list | grep Pillow
# Vous devriez voir Pillow, lxml, et d'autres packages
```

---

### âœ… Ã‰tape 1.4 : TÃ©lÃ©charger le modÃ¨le de base franÃ§ais

```bash
# CrÃ©er le dossier pour les modÃ¨les de base
mkdir -p tessdata_best

# TÃ©lÃ©charger le modÃ¨le franÃ§ais (14 MB environ)
wget -O tessdata_best/fra.traineddata https://github.com/tesseract-ocr/tessdata_best/raw/main/fra.traineddata

# Alternative avec curl (si wget n'existe pas)
curl -L -o tessdata_best/fra.traineddata \
  https://github.com/tesseract-ocr/tessdata_best/raw/main/fra.traineddata
```

**âœ”ï¸ VÃ©rification :**
```bash
ls -lh tessdata_best/fra.traineddata
# Taille attendue : environ 14-15 MB
```

---

## ğŸ“„ PHASE 2 : CRÃ‰ATION DE LA BASE D'ENTRAÃNEMENT

**âš ï¸ Ã‰TAPE CRUCIALE - La qualitÃ© de vos donnÃ©es dÃ©termine la qualitÃ© du modÃ¨le**

### âœ… Ã‰tape 2.1 : CrÃ©er la structure de dossiers

```bash
# Dans le dossier tesstrain/
mkdir -p data/fra_manuscrit-ground-truth
```

**ğŸ“‚ Structure attendue :**
```
tesstrain/
â”œâ”€â”€ data/
â”‚   â””â”€â”€ fra_manuscrit-ground-truth/
â”‚       â”œâ”€â”€ copie1.png
â”‚       â”œâ”€â”€ copie1.gt.txt
â”‚       â”œâ”€â”€ copie2.png
â”‚       â”œâ”€â”€ copie2.gt.txt
â”‚       â””â”€â”€ ...
â”œâ”€â”€ tessdata_best/
â”‚   â””â”€â”€ fra.traineddata
â”œâ”€â”€ Makefile
â””â”€â”€ requirements.txt
```

---

### âœ… Ã‰tape 2.2 : PrÃ©parer le texte d'entraÃ®nement

CrÃ©ez un fichier `texte_entrainement.txt` contenant environ 200-300 mots reprÃ©sentatifs des copies d'examens :

```text
Question 1 : DÃ©finissez les trois Ã©tats de la matiÃ¨re.
Les trois Ã©tats de la matiÃ¨re sont : l'Ã©tat solide, l'Ã©tat liquide et l'Ã©tat gazeux.
Un solide possÃ¨de une forme et un volume dÃ©finis. Un liquide a un volume dÃ©fini mais prend la forme de son contenant.
Un gaz n'a ni forme ni volume dÃ©finis et remplit tout l'espace disponible.

Question 2 : Expliquez le cycle de l'eau.
Le cycle de l'eau comprend quatre Ã©tapes principales : l'Ã©vaporation, la condensation, les prÃ©cipitations et le ruissellement.
L'eau s'Ã©vapore des ocÃ©ans et des lacs, forme des nuages par condensation, retombe sous forme de pluie ou de neige, puis retourne aux ocÃ©ans via les riviÃ¨res.

Question 3 : Calculez la surface d'un rectangle de longueur 8 cm et largeur 5 cm.
Surface = Longueur Ã— Largeur
Surface = 8 cm Ã— 5 cm = 40 cmÂ²
La surface du rectangle est de 40 centimÃ¨tres carrÃ©s.
```

**ğŸ’¡ Conseil :** Adaptez ce texte aux types de questions de vos examens (mathÃ©matiques, sciences, histoire, etc.).

---

### âœ… Ã‰tape 2.3 : Collecter les Ã©chantillons manuscrits

#### ğŸ“ MÃ©thode recommandÃ©e :

1. **Imprimer le texte** d'entraÃ®nement sur plusieurs feuilles
2. **Faire recopier** par 10-20 personnes diffÃ©rentes (Ã©lÃ¨ves, collÃ¨gues, famille)
3. **Scanner ou photographier** chaque copie :
   - **RÃ©solution minimum :** 300 DPI
   - **Format :** PNG ou TIFF (Ã©viter JPEG pour l'entraÃ®nement)
   - **Ã‰clairage :** Uniforme, sans ombres
   - **QualitÃ© :** Texte net, pas de flou

4. **Nommer les fichiers** de maniÃ¨re cohÃ©rente :
   ```
   eleve_001.png
   eleve_002.png
   eleve_003.png
   ...
   ```

---

### âœ… Ã‰tape 2.4 : CrÃ©er les fichiers de vÃ©ritÃ© terrain (ground truth)

Pour chaque image, crÃ©ez un fichier `.gt.txt` avec **EXACTEMENT** le mÃªme nom et le texte transcrit.

#### ğŸ¤– Script Python pour automatiser :

```python
import os
import shutil

# Chemin vers vos images scannÃ©es
SOURCE_IMAGES = "/chemin/vers/vos/images/"
# Chemin vers le dossier tesstrain
DEST_FOLDER = "~/Documents/tesstrain/data/fra_manuscrit-ground-truth/"

# Le texte de rÃ©fÃ©rence (ce qui a Ã©tÃ© recopiÃ©)
TEXTE_REFERENCE = """Question 1 : DÃ©finissez les trois Ã©tats de la matiÃ¨re.
Les trois Ã©tats de la matiÃ¨re sont : l'Ã©tat solide, l'Ã©tat liquide et l'Ã©tat gazeux.
Un solide possÃ¨de une forme et un volume dÃ©finis. Un liquide a un volume dÃ©fini mais prend la forme de son contenant.
Un gaz n'a ni forme ni volume dÃ©finis et remplit tout l'espace disponible.

Question 2 : Expliquez le cycle de l'eau.
Le cycle de l'eau comprend quatre Ã©tapes principales : l'Ã©vaporation, la condensation, les prÃ©cipitations et le ruissellement.
L'eau s'Ã©vapore des ocÃ©ans et des lacs, forme des nuages par condensation, retombe sous forme de pluie ou de neige, puis retourne aux ocÃ©ans via les riviÃ¨res.

Question 3 : Calculez la surface d'un rectangle de longueur 8 cm et largeur 5 cm.
Surface = Longueur Ã— Largeur
Surface = 8 cm Ã— 5 cm = 40 cmÂ²
La surface du rectangle est de 40 centimÃ¨tres carrÃ©s."""

# CrÃ©er les paires image + ground truth
for filename in os.listdir(SOURCE_IMAGES):
    if filename.endswith(('.png', '.tif', '.tiff')):
        # Copier l'image
        base_name = os.path.splitext(filename)[0]
        shutil.copy(
            os.path.join(SOURCE_IMAGES, filename),
            os.path.join(DEST_FOLDER, f"{base_name}.png")
        )
        
        # CrÃ©er le fichier .gt.txt
        with open(os.path.join(DEST_FOLDER, f"{base_name}.gt.txt"), 'w', encoding='utf-8') as f:
            f.write(TEXTE_REFERENCE)
        
        print(f"âœ… TraitÃ© : {base_name}")

print(f"\nğŸ‰ TerminÃ© ! {len(os.listdir(DEST_FOLDER))//2} paires crÃ©Ã©es.")
```

**âœ”ï¸ VÃ©rification finale :**
```bash
cd data/fra_manuscrit-ground-truth/
ls -l | wc -l
# Doit afficher un nombre PAIR (chaque image a son .gt.txt)
```

---

## ğŸš€ PHASE 3 : LANCEMENT DU FINE-TUNING

**â±ï¸ Temps estimÃ© : 30 minutes Ã  4 heures selon votre machine**

### âœ… Ã‰tape 3.1 : Lancer l'entraÃ®nement

```bash
# Retourner Ã  la racine de tesstrain
cd ~/Documents/tesstrain

# Lancer l'entraÃ®nement (COMMANDE COMPLÃˆTE)
make training \
  MODEL_NAME=fra_manuscrit \
  START_MODEL=fra \
  TESSDATA=./tessdata_best \
  MAX_ITERATIONS=10000 \
  EPOCHS=1

# Pour un test rapide (1000 itÃ©rations, environ 15-30 min)
make training \
  MODEL_NAME=fra_manuscrit \
  START_MODEL=fra \
  TESSDATA=./tessdata_best \
  MAX_ITERATIONS=1000
```

**ğŸ“Š Explication des paramÃ¨tres :**

- `MODEL_NAME=fra_manuscrit` : Nom de votre modÃ¨le (doit correspondre au dossier)
- `START_MODEL=fra` : ModÃ¨le de base Ã  amÃ©liorer
- `TESSDATA=./tessdata_best` : Localisation du modÃ¨le de base
- `MAX_ITERATIONS=10000` : Nombre de cycles d'apprentissage
  - **1000** : Test rapide (30 min)
  - **5000** : Bon compromis (1-2h)
  - **10000** : Production (2-4h)

**ğŸ“ˆ Ce qui se passe pendant l'entraÃ®nement :**

```
At iteration 100/10000, Mean rms=1.234%, delta=0.456%, char train=2.345%, word train=12.345%
At iteration 200/10000, Mean rms=1.123%, delta=0.345%, char train=2.123%, word train=11.234%
...
```

- **char train** : Taux d'erreur sur les caractÃ¨res (objectif : < 1%)
- **word train** : Taux d'erreur sur les mots (objectif : < 5%)

**âš ï¸ L'entraÃ®nement peut prendre du temps - NE PAS INTERROMPRE**

---

### âœ… Ã‰tape 3.2 : VÃ©rifier la fin de l'entraÃ®nement

```bash
# Ã€ la fin, vous devriez voir :
# "Finished training at iteration XXXX"

# VÃ©rifier que le modÃ¨le est crÃ©Ã©
ls -lh data/fra_manuscrit.traineddata
# Taille attendue : 10-20 MB
```

**âœ”ï¸ Fichier crÃ©Ã© avec succÃ¨s !** Passez Ã  l'Ã©tape suivante.

---

## ğŸ”— PHASE 4 : INTÃ‰GRATION DANS VOTRE APPLICATION

### âœ… Ã‰tape 4.1 : Copier le modÃ¨le dans Tesseract

#### Sur Windows :

```powershell
# Trouver le dossier tessdata de votre installation
# GÃ©nÃ©ralement : C:\Program Files\Tesseract-OCR\tessdata

# Copier votre modÃ¨le
copy "C:\Users\VotreNom\Documents\tesstrain\data\fra_manuscrit.traineddata" ^
     "C:\Program Files\Tesseract-OCR\tessdata\"
```

#### Sur Mac/Linux :

```bash
# Trouver le dossier tessdata
tesseract --list-langs
# Affiche le chemin, ex: /usr/local/share/tessdata

# Copier le modÃ¨le
sudo cp ~/Documents/tesstrain/data/fra_manuscrit.traineddata \
        /usr/local/share/tessdata/
```

**âœ”ï¸ VÃ©rification :**
```bash
tesseract --list-langs
# Vous devriez voir "fra_manuscrit" dans la liste
```

---

### âœ… Ã‰tape 4.2 : Modifier `ocr_service.py`

Ouvrez votre fichier `app/services/ocr_service.py` et modifiez la ligne 32 :

```python
# AVANT (ligne 32)
texte = pytesseract.image_to_string(preprocessed_img, lang="fra")

# APRÃˆS (ligne 32)
texte = pytesseract.image_to_string(preprocessed_img, lang="fra_manuscrit")
```

**Modification complÃ¨te de la fonction :**

```python
def extract_text_per_page(pdf_path: str) -> list:
    """
    Extrait le texte page par page d'un fichier PDF avec le modÃ¨le manuscrit.
    """
    print(f"ğŸ“„ Lancement de l'extraction page par page pour {os.path.basename(pdf_path)}")
    try:
        images = convert_from_path(pdf_path, dpi=300)
        textes = []
        for i, img in enumerate(images):
            print(f"  - OCR sur la page {i + 1}/{len(images)}...")
            preprocessed_img = _preprocess_image_for_ocr(img)
            
            # âœ¨ UTILISATION DU MODÃˆLE MANUSCRIT
            texte = pytesseract.image_to_string(
                preprocessed_img, 
                lang="fra_manuscrit",  # â† CHANGEMENT ICI
                config='--psm 6'        # Mode dÃ©tection de bloc de texte
            )
            textes.append(texte)

        print(f"âœ… Extraction terminÃ©e. {len(textes)} pages traitÃ©es.")
        return textes
    except Exception as e:
        print(f"âŒ Erreur lors de l'extraction : {str(e)}")
        return []
```

---

### âœ… Ã‰tape 4.3 : Ajouter une configuration dans `config.py`

```python
# Dans app/config.py, ajouter :

# ====================================
# CONFIGURATION OCR AVANCÃ‰E
# ====================================

# ModÃ¨le Tesseract Ã  utiliser
TESSERACT_MODEL = os.getenv("TESSERACT_MODEL", "fra_manuscrit")

# Configuration PSM (Page Segmentation Mode)
# 3 = Automatic page segmentation (dÃ©faut)
# 6 = Assume a single uniform block of text
# 11 = Sparse text. Find as much text as possible
TESSERACT_PSM = int(os.getenv("TESSERACT_PSM", 6))
```

**Puis dans `ocr_service.py` :**

```python
from app.config import TESSERACT_PATH, TESSERACT_MODEL, TESSERACT_PSM

# Modifier la ligne d'extraction
texte = pytesseract.image_to_string(
    preprocessed_img, 
    lang=TESSERACT_MODEL,
    config=f'--psm {TESSERACT_PSM}'
)
```

---

### âœ… Ã‰tape 4.4 : Tester le nouveau modÃ¨le

```bash
# Lancer votre application
cd C:/Users/jacke/PycharmProjects/fastApiProject
python -m uvicorn app.main:app --reload --port 8001

# Dans un autre terminal, tester avec une copie manuscrite
curl -X POST "http://localhost:8001/upload-copies-bundle" \
  -F "file=@/chemin/vers/copie_test.pdf"
```

**âœ”ï¸ Observation attendue :**
- Les logs montrent `OCR sur la page 1/X...`
- Le texte extrait est **beaucoup plus prÃ©cis** qu'avant
- Les noms d'Ã©lÃ¨ves sont correctement reconnus

---

## ğŸ¨ PHASE 5 : OPTIMISATIONS AVANCÃ‰ES

### ğŸ”¥ Optimisation 1 : AmÃ©liorer le prÃ©traitement

Ajoutez ces options dans `_preprocess_image_for_ocr()` :

```python
def _preprocess_image_for_ocr(image: Image.Image) -> Image.Image:
    """
    PrÃ©traitement avancÃ© pour manuscrits.
    """
    open_cv_image = np.array(image)
    gray = cv2.cvtColor(open_cv_image, cv2.COLOR_BGR2GRAY)
    
    # ğŸ†• NOUVEAU : RÃ©duction du bruit
    denoised = cv2.fastNlMeansDenoising(gray, None, 10, 7, 21)
    
    # ğŸ†• NOUVEAU : Augmentation du contraste (CLAHE)
    clahe = cv2.createCLAHE(clipLimit=2.0, tileGridSize=(8,8))
    contrast = clahe.apply(denoised)
    
    # Binarisation
    _, thresh = cv2.threshold(contrast, 0, 255, cv2.THRESH_BINARY_INV + cv2.THRESH_OTSU)
    final_image = cv2.bitwise_not(thresh)
    
    return Image.fromarray(final_image)
```

---

### ğŸ”¥ Optimisation 2 : Utiliser plusieurs modÃ¨les en parallÃ¨le

```python
def extract_text_hybrid(image: Image.Image) -> str:
    """
    Utilise fra_manuscrit ET fra pour une meilleure prÃ©cision.
    """
    preprocessed = _preprocess_image_for_ocr(image)
    
    # ModÃ¨le manuscrit (prioritaire)
    texte_manuscrit = pytesseract.image_to_string(
        preprocessed, 
        lang="fra_manuscrit",
        config='--psm 6'
    )
    
    # ModÃ¨le standard (backup)
    texte_standard = pytesseract.image_to_string(
        preprocessed, 
        lang="fra",
        config='--psm 6'
    )
    
    # Retourner le texte le plus long (gÃ©nÃ©ralement le meilleur)
    return texte_manuscrit if len(texte_manuscrit) > len(texte_standard) else texte_standard
```

---

### ğŸ”¥ Optimisation 3 : RÃ©entraÃ®ner avec plus de donnÃ©es

AprÃ¨s avoir testÃ© votre modÃ¨le :

1. **Identifiez les erreurs** rÃ©currentes
2. **Collectez plus d'exemples** de ces cas difficiles
3. **Ajoutez-les** au dossier `fra_manuscrit-ground-truth/`
4. **Relancez l'entraÃ®nement** avec `MAX_ITERATIONS=15000`

```bash
# Ajouter nouvelles donnÃ©es
cp nouvelles_copies/*.png data/fra_manuscrit-ground-truth/
cp nouvelles_copies/*.gt.txt data/fra_manuscrit-ground-truth/

# RÃ©entraÃ®ner (reprend oÃ¹ il s'Ã©tait arrÃªtÃ©)
make training \
  MODEL_NAME=fra_manuscrit \
  START_MODEL=fra_manuscrit \
  TESSDATA=./tessdata_best \
  MAX_ITERATIONS=15000
```

---

## ğŸ› ï¸ DÃ‰PANNAGE

### âŒ Erreur : "Tesseract model not found"

```bash
# VÃ©rifier que le modÃ¨le est au bon endroit
tesseract --list-langs | grep fra_manuscrit

# Si absent, recopier le fichier
sudo cp data/fra_manuscrit.traineddata /usr/local/share/tessdata/
```

---

### âŒ Erreur : "Make: command not found"

```bash
# Sur Windows WSL
sudo apt-get install make

# Sur Mac
xcode-select --install
```

---

### âŒ L'entraÃ®nement s'arrÃªte trop tÃ´t

Augmentez les itÃ©rations ou ajustez le critÃ¨re d'arrÃªt :

```bash
make training \
  MODEL_NAME=fra_manuscrit \
  START_MODEL=fra \
  TESSDATA=./tessdata_best \
  MAX_ITERATIONS=20000 \
  STOP_TRAINING_EARLY=false
```

---

### âŒ Le modÃ¨le ne reconnaÃ®t toujours pas bien

**Causes possibles :**

1. **Pas assez de donnÃ©es** â†’ Collectez 20-30 copies minimum
2. **QualitÃ© des scans** â†’ VÃ©rifiez la rÃ©solution (300 DPI minimum)
3. **Texte trop variÃ©** â†’ EntraÃ®nez sur le type exact de vos examens
4. **Ground truth incorrecte** â†’ VÃ©rifiez que les `.gt.txt` sont exacts

---

## ğŸ“Š RÃ‰SULTATS ATTENDUS

### Avant le modÃ¨le personnalisÃ© :
```
Texte extrait : "N0m : Je4n Dup0nt   C1asse : CM2"
PrÃ©cision : ~60-70%
```

### AprÃ¨s le modÃ¨le personnalisÃ© :
```
Texte extrait : "Nom : Jean Dupont   Classe : CM2"
PrÃ©cision : ~85-95%
```

---

## ğŸ¯ CHECKLIST FINALE

- [ ] Tesseract installÃ© et fonctionnel
- [ ] DÃ©pÃ´t `tesstrain` clonÃ©
- [ ] ModÃ¨le `fra.traineddata` tÃ©lÃ©chargÃ©
- [ ] 10-20 copies manuscrites scannÃ©es (300 DPI, PNG)
- [ ] Fichiers `.gt.txt` crÃ©Ã©s pour chaque image
- [ ] EntraÃ®nement lancÃ© et terminÃ© sans erreur
- [ ] ModÃ¨le `fra_manuscrit.traineddata` gÃ©nÃ©rÃ©
- [ ] ModÃ¨le copiÃ© dans le dossier `tessdata`
- [ ] `ocr_service.py` modifiÃ© pour utiliser `fra_manuscrit`
- [ ] Application testÃ©e avec succÃ¨s

---

## ğŸ“š RESSOURCES SUPPLÃ‰MENTAIRES

- **Documentation officielle Tesseract** : https://tesseract-ocr.github.io/
- **DÃ©pÃ´t tesstrain** : https://github.com/tesseract-ocr/tesstrain
- **Guide d'amÃ©lioration OCR** : https://github.com/tesseract-ocr/tessdoc

---

**ğŸ‰ FÃ©licitations ! Vous avez crÃ©Ã© votre modÃ¨le Tesseract personnalisÃ© !**

Votre systÃ¨me de correction automatique devrait maintenant Ãªtre beaucoup plus prÃ©cis sur l'Ã©criture manuscrite de vos Ã©lÃ¨ves.